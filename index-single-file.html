<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>30 ng√†y bye bye m·ª° b·ª•ng</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#fff0f5;color:#4a4a4a}
  .wrap{max-width:1200px;margin:24px auto;padding:16px;background:#ffe6f0;border:1px solid #f8cfe0;border-radius:16px}
  h1{font-size:32px;margin:0 0 20px;font-weight:700;color:#b03060;text-align:center;font-style:italic;display:flex;align-items:center;justify-content:center;gap:12px}
  h1 span{font-size:36px}
  h1 img{height:40px;width:auto}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center;justify-content:center}
  .pill{display:flex;gap:6px;align-items:center;background:#ffd6e8;border:1px solid #f5a9c5;padding:6px 10px;border-radius:10px;color:#b03060}
  button,input,textarea{padding:8px 12px;border-radius:10px;border:1px solid #f5a9c5;background:#fff;color:#b03060;cursor:pointer}
  button:hover{background:#ffe6f0}
  #durControl{display:flex;align-items:center;gap:6px;background:#ffd6e8;border:1px solid #f5a9c5;padding:6px 10px;border-radius:10px;color:#b03060}
  #dur{width:50px;text-align:center}
  .list{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:14px}
  .row{display:flex;flex-direction:column;align-items:center;justify-content:center;background:#fff0f5;border:1px solid #f5a9c5;border-radius:10px;padding:6px;cursor:grab}
  .row.active{border-color:#b03060;box-shadow:0 0 0 1px #f5a9c5 inset}
  .num{display:inline-flex;align-items:center;justify-content:center;height:36px;width:36px;margin-bottom:4px;border-radius:50%;background:#ffd6e8;border:1px solid #f5a9c5;color:#b03060;font-weight:700}
  .row textarea{width:90%;min-height:48px;max-height:60px;padding:6px 8px;border-radius:8px;border:1px solid #f5a9c5;background:#fff;color:#b03060;text-align:center;resize:none;line-height:1.3}
  .stage{position:relative;min-height:420px;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid #f5a9c5;border-radius:14px}
  .stage img{max-width:100%;max-height:70vh;border-radius:12px;display:block}
  .error{margin-top:10px;color:#b03060;background:#ffe6f0;border:1px solid #f5a9c5;padding:8px 10px;border-radius:8px;display:none}
  .dz{display:none}
  .bar{height:8px;background:#ffe6f0;border:1px solid #f5a9c5;border-radius:10px;overflow:hidden;margin-top:10px}
  .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,#ff80ab,#f06292)}
  .thumbs{display:flex;gap:8px;overflow:auto;margin-top:10px;padding-bottom:6px}
  .thumb img{height:64px;width:auto;border:2px solid #f5a9c5;border-radius:8px;opacity:.8;cursor:pointer}
  .thumb.active img{border-color:#b03060;opacity:1}
  #emojiUpload{display:none}
  #exportLink{display:none;margin-left:8px;color:#b03060}
  .group{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
</style>
</head>
<body>
  <div class="wrap">
    <h1><span>30 ng√†y bye bye m·ª° b·ª•ng</span><input type="file" id="emojiUpload" accept="image/*"></h1>
    <div class="controls">
      <div class="group">
        <input type="file" id="fileInput" accept="image/*" multiple>
        <button id="btnPrev">‚üµ Tr∆∞·ªõc</button>
        <button id="btnPlay">‚ñ∂Ô∏è Ph√°t</button>
        <button id="btnPause">‚è∏Ô∏è T·∫°m d·ª´ng</button>
        <button id="btnNext">Ti·∫øp ‚ü∂</button>
      </div>
      <div class="group">
        <label class="pill">T·ª± chuy·ªÉn <input type="checkbox" id="autoChk" checked></label>
        <div id="durControl">
          <button id="durMinus">-</button>
          <input id="dur" type="number" min="1" value="5"> s
          <button id="durPlus">+</button>
        </div>
        <button id="btnSaveLocal">üíæ L∆∞u t·∫°i m√°y</button>
        <button id="btnLoadLocal">‚§¥Ô∏è T·∫£i b·∫£n ƒë√£ l∆∞u</button>
        <button id="btnExportHtml">üì§ L∆∞u vƒ©nh vi·ªÖn (xu·∫•t HTML)</button>
        <a id="exportLink" download>‚¨áÔ∏è T·∫£i file</a>
      </div>
    </div>

    <!-- Danh s√°ch huy·ªát ph√≠a tr√™n ·∫£nh -->
    <div id="nameList" class="list"></div>

    <div class="stage">
      <img id="img" alt="·∫¢nh huy·ªát" />
    </div>
    <div class="bar"><span id="progress"></span></div>
    <div id="err" class="error"></div>
    <div id="thumbs" class="thumbs"></div>
  </div>

<script>
let playlist = [];
let idx = 0; let timer = null;
let names = Array.from({length:9}, (_,i)=>`Huy·ªát ${i+1}`);

const listEl = document.getElementById('nameList');
const imgEl = document.getElementById('img');
const thumbsEl = document.getElementById('thumbs');
const progressEl = document.getElementById('progress');

function render(i){
  if(!playlist[i]){ imgEl.removeAttribute('src'); return; }
  imgEl.src = playlist[i].dataURL;
  highlightThumb(i);
  progressEl.style.width = '0%';
}

function renderThumbs(){
  thumbsEl.innerHTML = '';
  playlist.forEach((p,i)=>{
    const wrap = document.createElement('div'); wrap.className='thumb';
    const im = new Image(); im.src = p.dataURL; im.title = names[i] || p.name; im.onclick=()=>{ idx=i; render(idx); };
    wrap.appendChild(im);
    thumbsEl.appendChild(wrap);
  });
  highlightThumb(idx);
}
function highlightThumb(i){
  [...thumbsEl.children].forEach((el,k)=> el.classList.toggle('active',k===i));
}

function renderNameList(){
  listEl.innerHTML = '';
  for(let i=0;i<names.length;i++){
    const row = document.createElement('div'); row.className='row'; row.dataset.i=i; row.draggable=true;
    const num = document.createElement('div'); num.className='num'; num.textContent=i+1; row.appendChild(num);
    const textarea=document.createElement('textarea'); textarea.value=names[i]; row.appendChild(textarea);
    textarea.addEventListener('input',()=>{ names[i]=textarea.value; });
    row.addEventListener('click',(e)=>{ if(e.target===textarea) return; idx=i; render(idx); });
    listEl.appendChild(row);
  }
}

function filesToPlaylist(files){
  playlist=[]; idx=0;
  const readers=Array.from(files).map(file=>new Promise(resolve=>{
    const fr=new FileReader();
    fr.onload=e=>resolve({name:file.name,dataURL:e.target.result});
    fr.onerror=()=>resolve(null);
    fr.readAsDataURL(file);
  }));
  Promise.all(readers).then(list=>{
    playlist=list.filter(Boolean);
    renderNameList();
    renderThumbs();
    render(idx);
  });
}

// ==== Playback controls ====
function play(){
  clearTimeout(timer);
  if(!playlist.length) return;
  render(idx);
  const seconds=Math.max(1,Number(document.getElementById('dur').value)||5);
  const startAt=performance.now();
  function tick(now){
    const t=Math.min(1,(now-startAt)/(seconds*1000));
    progressEl.style.width=(t*100)+'%';
    if(t<1) requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
  timer=setTimeout(()=>{ if(document.getElementById('autoChk').checked) next(); },seconds*1000);
}
function pause(){ clearTimeout(timer); }
function next(){ idx=(idx+1)%playlist.length; play(); }
function prev(){ idx=(idx-1+playlist.length)%playlist.length; play(); }

// ==== Event bindings ====
document.getElementById('fileInput').addEventListener('change',e=>filesToPlaylist(e.target.files));
document.getElementById('btnPlay').onclick=play;
document.getElementById('btnPause').onclick=pause;
document.getElementById('btnNext').onclick=()=>{pause();next();};
document.getElementById('btnPrev').onclick=()=>{pause();prev();};
document.getElementById('durMinus').onclick=()=>{
  let v=Math.max(1,Number(document.getElementById('dur').value)||1);
  document.getElementById('dur').value=Math.max(1,v-1);
};
document.getElementById('durPlus').onclick=()=>{
  let v=Math.max(1,Number(document.getElementById('dur').value)||1);
  document.getElementById('dur').value=v+1;
};

// ==== Save/Load/Export ====
const LS_KEY='huyet_playlist_v1';
const LS_NAMES='huyet_names_v1';
document.getElementById('btnSaveLocal').onclick=()=>{
  localStorage.setItem(LS_KEY,JSON.stringify(playlist));
  localStorage.setItem(LS_NAMES,JSON.stringify(names));
  alert('ƒê√£ l∆∞u v√†o tr√¨nh duy·ªát.');
};
document.getElementById('btnLoadLocal').onclick=()=>{
  const p=JSON.parse(localStorage.getItem(LS_KEY)||'[]');
  const n=JSON.parse(localStorage.getItem(LS_NAMES)||'[]');
  if(!p.length){alert('Ch∆∞a c√≥ d·ªØ li·ªáu l∆∞u');return;}
  playlist=p; if(Array.isArray(n)&&n.length) names=n;
  idx=0; renderNameList(); renderThumbs(); render(idx);
};

// Xu·∫•t HTML vƒ©nh vi·ªÖn
function exportHtml(){
  const payload={playlist,names};
  const tpl=`<!DOCTYPE html><html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'><title>30 ng√†y bye bye m·ª° b·ª•ng (b·∫£n l∆∞u)</title>
  <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;padding:20px}img{max-width:100%%;border-radius:12px} .wrap{max-width:960px;margin:0 auto}</style>
  </head><body><div class='wrap'><h2>B·∫£n l∆∞u vƒ©nh vi·ªÖn</h2><p>M·ªü file n√†y b·∫±ng tr√¨nh duy·ªát ƒë·ªÉ xem l·∫°i danh s√°ch ·∫£nh v√† t√™n huy·ªát.</p><div id='viewer'></div><script>const BOOTSTRAP=${JSON.stringify(payload)};<\/script><script>(function(){const v=document.getElementById('viewer');if(!BOOTSTRAP||!BOOTSTRAP.playlist||!BOOTSTRAP.playlist.length){v.innerHTML='<p>Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';return;}for(let i=0;i<BOOTSTRAP.playlist.length;i++){const h=document.createElement('h3');h.textContent=(BOOTSTRAP.names&&BOOTSTRAP.names[i])||BOOTSTRAP.playlist[i].name||('·∫¢nh '+(i+1));const img=new Image();img.src=BOOTSTRAP.playlist[i].dataURL;v.appendChild(h);v.appendChild(img);}})();<\/script></div></body></html>`;
  const blob=new Blob([tpl],{type:'text/html'});
  const url=URL.createObjectURL(blob);
  const a=document.getElementById('exportLink');
  a.href=url; a.download='30ngay-huyet.html'; a.style.display='inline-block';
}
document.getElementById('btnExportHtml').onclick=exportHtml;

renderNameList();
</script>
</body>
</html>